---
title: Linux服务配置01
date: 2019-06-11 09:10:30
tags: [Devops,linux]
categories: Devops, linux
---
2019-06-11-Linux服务配置01
<!-- more -->

## 目录	<a id="back"></a>
* <a href="#fdisk" target="_self">分区/格式化/挂载/卸载</a>
* <a href="#uquota" target="_self">磁盘容量配额技术 uquota</a>
* <a href="#raid" target="_self">RAID 磁盘阵列</a>
* <a href="#lvm" target="_self">LVM 逻辑卷管理</a>
* <a href="#iptables" target="_self">iptables 参数 规则链 动作</a>
* <a href="#firewalld" target="_self">firewall-cmd 防火墙</a>
* <a href="#ssh" target="_self">SSH 服务</a>
* <a href="#scp" target="_self">scp 远程传输</a>
* <a href="#apache" target="_self">apache 服务</a>

### 1. 一切从  / 开始
{% asset_img jiegou.jpg [文件系统与目录结构] %}  

| 类别        | 说明                                         |
| :---------- | :------------------------------------------- |
| /boot       | 开机所需文件——内核、开机菜单以及所需配置文件 |
| /dev        | 以文件形式存放任何设备及接口                 |
| /etc        | 配置文件                                     |
| /home       | 用户家目录                                   |
| /bin        | 存放单用户模式下还可以操作的命令             |
| /lib        | 开机时用到的函数库                           |
| /sbin       | 开机过程中用到的命令                         |
| /media      | 挂载设备文件的目录                           |
| /opt        | 第三方软件                                   |
| /root       | 系统管理员家目录                             |
| /srv        | 网络服务的数据文件目录                       |
| /tmp        | 任何人均可使用的“共享”临时目录               |
| /proc       | 虚拟文件系统                                 |
| /usr/local  | 用户自行安装的软件                           |
| /usr/sbin   | 开机不会使用的软件及脚本                     |
| /usr/share  | 帮助与说明文件                               |
| /var        | 经常变化文件,日志                            |
| /lost+found | 当文件系统发生错误，存放丢失的文件片段       |

### 2. 路径   
绝对路径：从根目录(/)开始写起的文件或目录  
相对路径：相对于当前路径的写法  `./  ../  ~`

### 3. 物理设备的命名规则  
| 类别          | 说明                |
| :------------ | :------------------ |
| IDE           | /dev/hd[a-d]        |
| SCSI/SATA/U盘 | /dev/sd[a-p]        |
| 软驱          | /dev/fd[0-1]        |
| 打印机        | /dev/lp[0-15]       |
| 光驱          | /dev/cdrom          |
| 鼠标          | /dev/mouse          |
| 磁带机        | /dev/st0   /dev/ht0 |

* **主分区/扩展分区编号从1开始，到4结束　逻辑分区从编号5开始**   
硬盘设备是由大量扇区组成的，**每个扇区的容量为512字节**，第一个扇区最重要，保存了**主引导记录与分区表信息MBR**，主引导记录用446B，分区表用64B，结束符用2B；分区表记录一个**分区信息需要16B**，最多只有4个分区信息可以写到第一个扇区中，这四个分区就是4个主分区；
* 为了解决分区个数不够,可以将第一个扇区分区表中16B(原本写入主分区信息)的空间(称为扩展分区)拿出来指向另外一个分区表。**扩展分区不是一个真正的分区**,是一个占用16字节分区表空间的指针。所以,**用户一般会选择3个主分区加1个扩展分区,在扩展分区中建立数个逻辑分区**；

### 4. 文件系统与数据资料
| 选项 | 说明                                                            |
| :--- | :-------------------------------------------------------------- |
| EXT3 | 日志文件系统                                                    |
| Ext4 | Ext3改进版,RHEL6系统默认文件管理系统,支持存储容量高达1EB        |
| XFS  | 高性能的日志文件系统,RHEL7默认文件管理系统,最大支持存储容量18EB |

### 5. 挂载硬件设备 
**注：** mount -a 会自动检查/etc/fstab文件有无疏漏的挂载设备，若有则自动进行挂载

| 选项 | 说明                        |
| :--- | :-------------------------- |
| -t   | 指定文件的系统类型:iso9600  |
| -o   | 描述设备或档案的挂载方式    |
| ---  | loop:把文件当成硬盘分区挂载 |
| ---  | ro:只读方式                 |
| ---  | rw:读写方式                 |

```
[root@xy ~]# mount /dev/sdb2 /backup # 挂载目录需要挂载前创建好，mount[设备文件 挂在目录]  
[root@xy ~]# vim /etc/fstab	     # 开机自动挂载sdb2    
  1  #  
  2  # /etc/fstab  
  3  # Created by anaconda on Fri Jul  6 08:44:38 2018  
  4  #  
  5  # Accessible filesystems, by reference, are maintained under '/dev/disk'  
  6  # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info  
  7  #  
  8  /dev/mapper/rhel-root                      /         xfs       defaults        1 1  
  9  UUID=28d7b2f5-a322-4990-ab6c-5936d156fce7 /boot      xfs       defaults        1 2  
  10 /dev/mapper                              /rhel-swap  swap swap defaults        0 0  
  11 /dev/cdrom                              /media/cdrom iso9660   defaults        0 0  
  12 /dev/sdb2							  /backup		ext4      defaults        0 0  
```

### 6. 撤销挂载设备  <a id="fdisk"></a>
```
[root@xy ~]# umount /dev/sdb2　# umount [设备文件/挂在目录]
```

### 7. 分区-格式化-挂载:  
#### fdisk   
| 选项 | 说明                             |
| :--- | :------------------------------- |
| -m   | 查看全部可用参数                 |
| -n   | 添加新的分区，p主分区，e扩展分区 |
| -d   | 删除某个分区信息                 |
| -q   | 不保存退出                       |
| -l   | ✔列出所以可用的分区类型          |
| -t   | ✔改变某个分区的信息              |
| -p   | ✔查看分区信息                    |
| -w   | 保存并退出                       |

#### 7.1 分区： 
```
[root@xy ~]# fdisk /dev/sdb  # sd -->SATA
  Welcome to fdisk (util-linux 2.23.2).  

  Changes will remain in memory only, until you decide to write them.  
  Be careful before using the write command.  

  Device does not contain a recognized partition table  
  Building a new DOS disklabel with disk identifier 0x301a431a.  
   
Command (m for help): p 		　# 查看分区信息  
  Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors  
  Units = sectors of 1 * 512 = 512 bytes  
  Sector size (logical/physical): 512 bytes / 512 bytes  
  I/O size (minimum/optimal): 512 bytes / 512 bytes  
  Disk label type: dos  
  Disk identifier: 0x301a431a  
  
  Device Boot      Start         End      Blocks   Id  System  
 
Command (m for help): n 		　# 添加新的分区  
  Partition type:  
      p   primary (0 primary, 0 extended, 4 free)  
      e   extended  
  
Select (default p): p   
Partition number (1-4, default 1): 1  
  First sector (2048-41943039, default 2048):   
  Using default value 2048  
  Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): +2G # 创建2GB分区  
  Partition 1 of type Linux and of size 2 GiB is set  
  
Command (m for help): p 		　# 查看分区信息     
  Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors  
  Units = sectors of 1 * 512 = 512 bytes  
  Sector size (logical/physical): 512 bytes / 512 bytes  
  I/O size (minimum/optimal): 512 bytes / 512 bytes  
  Disk label type: dos  
  Disk identifier: 0x301a431a  

  Device Boot      Start         End      Blocks   Id  System  
  /dev/sdb1            2048     4196351     2097152   83  Linux  
  
Command (m for help): w 	# 保存分区信息并退出
  The partition table has been altered!  

  Calling ioctl() to re-read partition table.  
  Syncing disks.
   
[root@xy ~]# file /dev/sdb　# file 查看 /dev/sdb1 文件属性  
/dev/sdb1: cannot open (No such file or directory)
[root@xy ~]# partprobe　# partprobe 同步分区信息到系统内核 
[root@xy ~]# file /dev/sdb1  
/dev/sdb1: block special  
```

#### 7.2 格式化(创建文件系统类型)： mkfs.文件类型名称 /dev/sdb1   
```
[root@xy ~]# mkfs # 分区完后用 mkfs 格式化  
mkfs         mkfs.cramfs  mkfs.ext3    mkfs.fat     mkfs.msdos   mkfs.xfs
mkfs.btrfs   mkfs.ext2    mkfs.ext4    mkfs.minix   mkfs.vfat   
[root@xy ~]# mkfs -t xfs /dev/sdb1 
  meta-data=/dev/sdb1  isize=256  agcount=4, agsize=131072 blks  
  =  sectsz=512  attr=2, projid32bit=1  
  =  crc=0  
  data  =bsize=4096   blocks=524288, imaxpct=25  
  =  sunit=0  swidth=0 blks  
  naming  =version 2  bsize=4096   ascii-ci=0 ftype=0  
  log  =internal log  bsize=4096   blocks=2560, version=2  
  =  sectsz=512   sunit=0 blks, lazy-count=1  
  realtime =none  extsz=4096   blocks=0, rtextents=0
```

#### 7.3 挂载分区：
``` 
[root@xy ~]# mkdir /newFS
[root@xy ~]# mount /dev/sdb1 /newFS/  
[root@xy ~]# df -h 	　 # 查看挂载状态及设备 建议 df -Th 命令信息更全 
    
    Filesystem           Size  Used Avail Use% Mounted on  
    /dev/mapper/rhel-root   28G  3.0G   25G  11% /  
    devtmpfs               985M     0  985M   0% /dev  
    tmpfs                  994M  148K  994M   1% /dev/shm  
    tmpfs                  994M  8.8M  986M   1% /run  
    tmpfs                  994M     0  994M   0% /sys/fs/cgroup  
    /dev/sr0               3.5G  3.5G     0 100% /media/cdrom  
    /dev/sda1              497M  119M  379M  24% /boot  
    /dev/sdb1              2.0G   33M  2.0G   2% /newFS  
    
[root@xy ~]# cp -rf /etc/* /newFS
[root@xy ~]# ls /newFS
abrt hosts pulse  
adjtime host.allow purple  
........省略部分信息........  

[root@xy ~]# du -sh /newFS/ 　 # du -sh  查看空间占用情况  
33M /newFS/
```

### 8. 添加交换分区swap  
> 交换分区是把内存中暂时不用的数据临时存放到硬盘中,解决物理内存不足问题,交换分区一般为物理内存的1.5~2倍  ，mkswap 与 swapon  

#### 8.1 分区：
```
[root@xy ~]# fdisk /dev/sdb 　 # 分区  
Welcome to fdisk (util-linux 2.23.2).  

Changes will remain in memory only, until you decide to write them.  
Be careful before using the write command.  

Command (m for help): n
 Partition type:
   p   primary (1 primary, 0 extended, 3 free)  
   e   extended  

Select (default p): p 
 Partition number (2-4, default 2): 2  
  First sector (4196352-41943039, default 4196352):   
  Using default value 4196352  
  Last sector, +sectors or +size{K,M,G} (4196352-41943039, default 41943039): +5G  
  Partition 2 of type Linux and of size 5 GiB is set  

Command (m for help): p  
 Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors  
Units = sectors of 1 * 512 = 512 bytes  
Sector size (logical/physical): 512 bytes / 512 bytes  
I/O size (minimum/optimal): 512 bytes / 512 bytes  
Disk label type: dos  
Disk identifier: 0x301a431a  

 Device Boot      Start         End      Blocks   Id  System  
/dev/sdb1            2048     4196351     2097152   83  Linux  
/dev/sdb2         4196352    14682111     5242880   83  Linux  

Command (m for help): w  
 The partition table has been altered!  

 Calling ioctl() to re-read partition table.  

 WARNING: Re-reading the partition table failed with error 16: Device or resource busy.  
The kernel still uses the old table. The new table will be used at  
the next reboot or after you run partprobe(8) or kpartx(8)  
Syncing disks.  
```

#### 8.2 格式化： 
```
[root@xy ~]# mkswap /dev/sdb2  　# 格式化 mkswap  
/dev/sdb2: No such file or directory  
[root@xy ~]# partprobe  
[root@xy ~]# partprobe  
[root@xy ~]# mkswap /dev/sdb2  
Setting up swapspace version 1, size = 5242876 KiB  
no label, UUID=ffe8494a-c2f5-4af4-becf-985b130d395c  
[root@xy ~]# free -m  
             total       used       free     shared    buffers     cached  
Mem:          1987       1137        850          9          1        279  
-/+ buffers/cache:        856       1131  
Swap:            0          0          0  
```

#### 8.3 挂载分区： 
```
[root@xy ~]# swapon /dev/sdb2    　# 挂载使用  
[root@xy ~]# free -m  

             total       used       free     shared    buffers     cached  
Mem:          1987       1141        846          9          1        279  
-/+ buffers/cache:        860       1127  
Swap:         5119          0       5119  

[root@xy ~]# vim /etc/fstab 　# 设置自动挂载      
  1  #  
  2  # /etc/fstab  
  3  # Created by anaconda on Fri Jul  6 08:44:38 2018  
  4  #  
  5  # Accessible filesystems, by reference, are maintained under '/dev/disk'  
  6  # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info  
  7  #  
  /dev/mapper/rhel-root                  /         xfs       defaults        1 1    
  UUID=28d7b2f5-a322-4990-ab6c-5936d156fce7 /boot  xfs       defaults        1 2    
  /dev/mapper                          /rhel-swap  swap swap defaults        0 0  
  /dev/cdrom                          /media/cdrom iso9660   defaults        0 0    
  /dev/sdb1                          /newFS        xfs       defaults        0 0    
  /dev/sdb2                          swap          swap      defaults        0 0 
```

### 9. 删除手动增加的交换分区swap    
```
[root@xy ~]# /sbin/swapoff /dev/sdb2  
[root@xy ~]# vim /etc/fstab   
/dev/sdb2    swap     swap     defaults       0 0 　# 删除  
[root@xy ~]# swapon -s
Filename        Type      Size    Used  Priority  
/dev/dm-0       partition 2113532 0     -1  
```

### 10. 磁盘容量配额技术  <a id="uquota"></a>
**配置/etc/fstab,使/boot目录支持uquota,磁盘容量配额技术** 
```
UUID=28d7b2f5-a322-4990-ab6c-5936d156fce7 /boot    xfs    defaults,uquota 1 2
```
```
[root@xy ~]# reboot  
[root@xy ~]# mount | grep boot
/dev/sda1 on /boot type xfs (rw,relatime,seclablel,attr2,inode64,usrquota)  
[root@xy ~]# useradd tom   
[root@xy ~]# chmod -Rf o+w /boot 　# other write  
[root@xy ~]# xfs_quota -x -c 'limit bsoft=3m bhard=6m isoft=3 ihard=6 tom' /boot
[root@xy ~]# xfs_quota -x -c report /boot　# xfs_quota -x -c
  User quota on /boot (/dev/sda1)	  Blocks  
  User ID Used Soft Hard Warn/Grace  
  ----------- ----------------------------------------------  
  root 95084   0     0    00 [--------] 
  tom  0       3072  6144 00 [--------] 

[root@xy ~]# su - tom  
[tom@xy ~]$ dd if=/dev/zero of=/boot/tom bs=5M count=1  
  1+0 records in  
  1+0 records out  
  5242880 bytes (5.2 MB) copied, 0.123996 s, 42.3 MB/s  

[tom@xy ~]$ dd if=/dev/zero of=/boot/tom bs=8M count=1
  dd: error writing '/boot/tom': Disk quato exceeded 　 # 限制  
  1+0 records in  
  1+0 records out  
  6291456 bytes (6.3 MB) copied, 0.0201596s, 312MB/s  

[root@xy ~]# edquota -u tom　 # edquota -u 按需修改配额    
  Disk quotas for user tom (uid 1001):  
  Filesystem blocks   soft   hard   inodes   soft   hard  
  /dev/sda   6114     3072   8192   1        3      6  

[root@xy ~]# su - tom
[tom@xy ~]$ dd if=/dev/zero of=/boot/tom bs=8M count=1  
  1+0 records in  
  1+0 records out  
  8388608 bytes (8.4 MB) copied, 0.0238044s, 313MB/s  
[tom@xy ~]$ dd if=/dev/zero of=/boot/tom bs=10M count=1  
  dd: error writing '/boot/tom': Disk quato exceeded  
  1+0 records in  
  1+0 records out  
  8388608 bytes (8.4 MB) copied, 0.0238044s, 313MB/s  
```

### 11. 创建链接文件ln  
[cnblog参考](https://www.cnblogs.com/ricklz/p/9378755.html)  

```
[root@xy /]# ln -s ../usr/share/zoneinfo/Asia/Shanghai /etc/localtime #相对目录建立, 找相对于链接的根目录
```
> 硬链接与软链接的区别:  
  >> 硬链接：**只能应用于文件**不能应用于目录；以文件**副本**形式存在；不能跨文件系统；inode节点号不变，链接增长数会增加；源文件删除不影响链接文件；  
  >> 软连接：既应用于文件也应用与目录；以**路径**形式存在；可跨文件系统；inode节点号不同，链接增长数不变；源文件删除影响链接文件；大小为路径包含的字符个数；
  >> 链接数：指向这个inode文件名的数量；

### 12. RAID与LVM磁盘阵列技术  <a id="raid"></a>
+ RAID(fd)(Redundant Array of Independent Disks,独立冗余磁盘阵列)

+ **RAID 0(Srtiping)**:把多块物理硬件设备(至少2块)通过硬件或软件凡事串联在一起,组成一个大的卷组,提升了硬盘数据的吞吐量,但不具备数据备份和错误修复能力； 
  * 性能提升：读写；
  * 冗余(容错)能力：无；
  * 空间利用率：ns(s--> 一块盘利用率)
  * 至少2块
{% asset_img RAID0.png [RAID 0--条带] %}

+ **RAID 1(Mirroring)**:数据写到多块硬盘设备上,当某一块硬盘发生故障后,一般会立即以热交换方式来恢复数据的正常使用,但硬盘的使用率却下降了,只有33%左右 ✔   
  * 性能提升：写下降，读提升；
  * 冗余能力：有；
  * 空间利用率：1/2
  * 至少2块
{% asset_img raid1.jpg [RAID 1--镜像] %}

+ **RAID 5**:将硬盘设备的数据奇偶校验信息保存到除自身外每一块硬盘设备上,当硬盘出现问题,通过奇偶校验信息来尝试重建损坏的数据  ✔
  * 性能提升：读写提升；
  * 冗余能力：有；
  * 空间利用率：(n-1)s/n
  * 至少3块
{% asset_img raid5.jpg [RAID 5--校验] %}

+ **RAID 10**：RAID10=RAID 1 + RAID 0
  * 性能提升：读写提升；
  * 冗余能力：有；
  * 空间利用率：1/2
  * 至少4块
{% asset_img raid-10.png [RAID 10--综合] %}

+ mdadm 命令

  | 选项 | 说明             |
  | :--- | :--------------- |
  | -C   | 创建 ✔           |
  | -v   | 显示过程 ✔       |
  | -a   | 检测设备名称     |
  | -n   | 指定设备数量 ✔   |
  | -l   | 指定RAID级别     |
  | -D   | 查看详细信息 ✔   |
  | -f   | 模拟设备损坏     |
  | -Q   | 查看摘要信息     |
  | -r   | 移除设备         |
  | -S   | 停止RAID磁盘阵列 |
  | -x   | 备用盘           |

### 12.1 部署磁盘阵列RAID 5(也可以拿分区做实验)
